// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ─── User & Authentication ───────────────────────────────────

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  password      String
  phone         String?
  avatar        String?
  role          UserRole
  status        UserStatus @default(ACTIVE)
  mustChangePassword Boolean @default(false)
  lastPasswordChange DateTime?
  branchId      String?
  branch        Branch?   @relation(fields: [branchId], references: [id])
  
  // Relations
  bookingsCreated    Booking[]    @relation("BookingCreatedBy")
  ordersCreated      Order[]      @relation("OrderCreatedBy")
  shifts            Shift[]
  performanceReviews PerformanceReview[]
  messagesSent      Message[]    @relation("MessageSender")
  messagesReceived  Message[]    @relation("MessageReceiver")
  notifications     Notification[]
  
  // Metadata
  joinDate      DateTime  @default(now())
  lastLogin     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([email])
  @@index([branchId])
  @@index([role])
}

enum UserRole {
  SUPER_ADMIN
  SUPER_MANAGER
  BRANCH_MANAGER
  RECEPTIONIST
  WAITER
  RESTAURANT_STAFF
  CHEF
  KITCHEN_STAFF
  HOUSEKEEPING
  SPA_THERAPIST
  ACCOUNTANT
  EVENT_MANAGER
  SECURITY
  MAINTENANCE
  DRIVER
}

enum UserStatus {
  ACTIVE
  ON_LEAVE
  SUSPENDED
  TERMINATED
}

// ─── Branch  ──────────────────────────────────────────────────

model Branch {
  id              String    @id @default(cuid())
  name            String
  location        String
  city            String
  province        String
  country         String    @default("Rwanda")
  phone           String
  email           String
  totalRooms      Int
  
  // Manager
  managerId       String?
  managerName     String?
  
  // Relations
  users           User[]
  rooms           Room[]
  bookings        Booking[]
  guests          Guest[]
  orders          Order[]
  events          Event[]
  services        Service[]
  revenue         Revenue[]
  menuItems       MenuItem[]
  
  // Settings
  checkInTime     String    @default("14:00")
  checkOutTime    String    @default("11:00")
  currency        String    @default("RWF")
  taxRate         Float     @default(0.18)
  
  // Metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([name])
  @@index([city])
}

// ─── Room & Inventory ─────────────────────────────────────────

model Room {
  id              String      @id @default(cuid())
  number          String
  floor           Int
  type            RoomType
  status          RoomStatus  @default(AVAILABLE)
  price           Int
  description     String?
  maxOccupancy    Int         @default(2)
  size            Int?        // Square meters
  view            String?
  
  // Features
  amenities       String[]    // WiFi, AC, TV, Minibar, etc.
  images          String[]
  
  // Branch
  branchId        String
  branch          Branch      @relation(fields: [branchId], references: [id])
  
  // Relations
  bookings        Booking[]
  currentGuest    Guest?      @relation("CurrentRoom", fields: [currentGuestId], references: [id])
  currentGuestId  String?
  maintenanceLogs MaintenanceLog[]
  housekeepingTasks HousekeepingTask[]
  
  // Metadata
  lastCleaned     DateTime?
  lastMaintenance DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@unique([branchId, number])
  @@index([branchId])
  @@index([status])
  @@index([type])
}

enum RoomType {
  STANDARD
  DELUXE
  FAMILY
  EXECUTIVE_SUITE
  PRESIDENTIAL_SUITE
}

enum RoomStatus {
  AVAILABLE
  OCCUPIED
  RESERVED
  CLEANING
  MAINTENANCE
  OUT_OF_SERVICE
}

// ─── Guest & CRM ──────────────────────────────────────────────

model Guest {
  id              String      @id @default(cuid())
  firstName       String
  lastName        String
  email           String      @unique
  phone           String
  nationality     String
  dateOfBirth     DateTime?
  gender          String?
  
  // ID Documents
  idType          String?     // Passport, National ID
  idNumber        String?
  idExpiry        DateTime?
  
  // Address
  address         String?
  city            String?
  country         String?
  postalCode      String?
  
  // Loyalty Program
  loyaltyTier     LoyaltyTier?
  loyaltyPoints   Int         @default(0)
  totalStays      Int         @default(0)
  totalSpent      Int         @default(0)
  
  // Preferences
  preferences     Json?       // Room preferences, dietary restrictions, etc.
  specialRequests String?
  
  // Marketing
  newsletter      Boolean     @default(false)
  marketingConsent Boolean    @default(false)
  
  // Relations
  bookings        Booking[]
  reviews         Review[]
  currentRooms    Room[]      @relation("CurrentRoom")
  
  // Branch
  branchId        String?
  branch          Branch?     @relation(fields: [branchId], references: [id])
  
  // Metadata
  avatar          String?
  lastVisit       DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // Smart Linking (Parent/Student style)
  parentGuestId   String?
  parentGuest     Guest?      @relation("FamilyLink", fields: [parentGuestId], references: [id])
  childGuests     Guest[]      @relation("FamilyLink")
  
  @@index([email])
  @@index([phone])
  @@index([loyaltyTier])
  @@index([branchId])
  @@index([parentGuestId])
}

enum LoyaltyTier {
  SILVER
  GOLD
  PLATINUM
  DIAMOND
}

// ─── Booking & Reservation ────────────────────────────────────

model Booking {
  id              String        @id @default(cuid())
  bookingNumber   String        @unique
  
  // Guest
  guestId         String
  guest           Guest         @relation(fields: [guestId], references: [id])
  
  // Room
  roomId          String
  room            Room          @relation(fields: [roomId], references: [id])
  
  // Dates
  checkInDate     DateTime
  checkOutDate    DateTime
  actualCheckIn   DateTime?
  actualCheckOut  DateTime?
  nights          Int
  
  // Guests
  adults          Int           @default(1)
  children        Int           @default(0)
  
  // Pricing
  roomRate        Int
  totalAmount     Int
  taxAmount       Int
  discountAmount  Int           @default(0)
  finalAmount     Int
  
  // Status
  status          BookingStatus @default(PENDING)
  paymentStatus   PaymentStatus @default(PENDING)
  paymentMethod   PaymentMethod?
  
  // Add-ons
  addOns          String[]
  specialRequests String?
  
  // Branch
  branchId        String
  branch          Branch        @relation(fields: [branchId], references: [id])
  
  // Staff
  createdById     String?
  createdBy       User?         @relation("BookingCreatedBy", fields: [createdById], references: [id])
  
  // Relations
  payments        Payment[]
  services        Service[]
  
  // Metadata
  source          BookingSource @default(WEBSITE)
  notes           String?
  cancellationReason String?
  cancelledAt     DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([guestId])
  @@index([roomId])
  @@index([branchId])
  @@index([status])
  @@index([checkInDate])
  @@index([checkOutDate])
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CHECKED_IN
  CHECKED_OUT
  CANCELLED
  NO_SHOW
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  REFUNDED
}

enum PaymentMethod {
  CASH
  VISA
  MASTERCARD
  AMEX
  STRIPE
  PAYPAL
  MTN_MOBILE
  AIRTEL_MONEY
  BANK_TRANSFER
}

enum BookingSource {
  WEBSITE
  PHONE
  WALK_IN
  BOOKING_COM
  EXPEDIA
  AGENT
  CORPORATE
}

// ─── Payment ──────────────────────────────────────────────────

model Payment {
  id              String        @id @default(cuid())
  transactionId   String        @unique
  amount          Int
  method          PaymentMethod
  status          PaymentStatus
  
  // Booking
  bookingId       String?
  booking         Booking?      @relation(fields: [bookingId], references: [id])
  
  // Event (if payment is for event)
  eventId         String?
  event           Event?        @relation(fields: [eventId], references: [id])
  
  // Details
  currency        String        @default("RWF")
  description     String?
  receiptUrl      String?
  
  // Gateway response
  gatewayResponse Json?
  
  // Metadata
  processedAt     DateTime?
  refundedAt      DateTime?
  refundAmount    Int?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([bookingId])
  @@index([eventId])
  @@index([status])
  @@index([transactionId])
}

// ─── Restaurant & Menu ────────────────────────────────────────

model MenuItem {
  id              String        @id @default(cuid())
  name            String
  nameKinyarwanda String?
  category        MenuCategory
  description     String?
  price           Int
  cost            Int?          // Cost to make (for profit calculation)
  
  // Details
  images          String[]
  ingredients     String[]
  allergens       String[]
  dietary         String[]      // Vegan, Vegetarian, Gluten-Free
  
  // Nutrition (per serving)
  calories        Int?
  protein         Int?
  carbs           Int?
  fat             Int?
  
  // Availability
  available       Boolean       @default(true)
  preparationTime Int?          // Minutes
  
  // Inventory
  requiresInventory Boolean     @default(false)
  lowStockAlert   Boolean       @default(false)
  
  // Relations
orderItems      OrderItem[]
  
  // Metadata
  popular         Boolean       @default(false)
  rating          Float?
  reviewCount     Int           @default(0)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Branch (Optional - if null, it's a global item)
  branchId        String?
  branch          Branch?       @relation(fields: [branchId], references: [id])
  
  @@index([category])
  @@index([available])
  @@index([branchId])
}

enum MenuCategory {
  BREAKFAST
  APPETIZER
  MAIN_COURSE
  DESSERT
  BEVERAGES
  COCKTAILS
  WINE
  AFRICAN_CUISINE
  INTERNATIONAL
}

model Order {
  id              String        @id @default(cuid())
  orderNumber     String        @unique
  
  // Location
  tableNumber     Int?
  roomNumber      String?
  
  // Customer
  guestName       String?
  guestId         String?
  roomCharge      Boolean       @default(false)
  
  // Items
  items           OrderItem[]
  
  // Pricing
  subtotal        Int
  tax             Int
  discount        Int           @default(0)
  total           Int
  
  // Status
  status          OrderStatus   @default(PENDING)
  priority        OrderPriority @default(NORMAL)
  
  // Branch
  branchId        String
  branch          Branch        @relation(fields: [branchId], references: [id])
  
  // Staff
  createdById     String?
  createdBy       User?         @relation("OrderCreatedBy", fields: [createdById], references: [id])
  
  // Kitchen
  sentToKitchen   DateTime?
  preparedAt      DateTime?
  servedAt        DateTime?
  
  // Payment
  paymentMethod   PaymentMethod?
  paymentStatus   PaymentStatus @default(PENDING)
  
  // Metadata
  notes           String?
  specialRequests String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([branchId])
  @@index([status])
  @@index([orderNumber])
  @@index([createdAt])
}

model OrderItem {
  id              String        @id @default(cuid())
  
  // Order
  orderId         String
  order           Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  // Menu Item
  menuItemId      String
  menuItem        MenuItem      @relation(fields: [menuItemId], references: [id])
  
  // Details
  quantity        Int
  price           Int
  subtotal        Int
  
  // Customization
  notes           String?
  modifications   String[]
  
  // Status
  status          OrderItemStatus @default(PENDING)
  
  // Metadata
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([orderId])
  @@index([menuItemId])
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  SERVED
  COMPLETED
  CANCELLED
}

enum OrderPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum OrderItemStatus {
  PENDING
  PREPARING
  READY
  SERVED
}

// ─── Events ───────────────────────────────────────────────────

model Event {
  id              String        @id @default(cuid())
  eventNumber     String        @unique
  name            String
  type            EventType
  
  // Date & Time
  eventDate       DateTime
  startTime       String
  endTime         String
  
  // Venue
  hall            String
  capacity        Int
  expectedGuests  Int
  actualGuests    Int?
  
  // Client
  organizerName   String
  organizerEmail  String
  organizerPhone  String
  organizerCompany String?
  
  // Services
  catering        Boolean       @default(false)
  audioVisual     Boolean       @default(false)
  decoration      Boolean       @default(false)
  
  // Pricing
  venueCharge     Int
  cateringCharge  Int           @default(0)
  equipmentCharge Int           @default(0)
  decorationCharge Int          @default(0)
  totalAmount     Int
  
  // Status
  status          EventStatus   @default(ENQUIRY)
  paymentStatus   PaymentStatus @default(PENDING)
  
  // Branch
  branchId        String
  branch          Branch        @relation(fields: [branchId], references: [id])
  
  // Relations
  payments        Payment[]
  
  // Metadata
  notes           String?
  specialRequests String?
  setupTime       String?
  breakdownTime   String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([branchId])
  @@index([type])
  @@index([status])
  @@index([eventDate])
}

enum EventType {
  CONFERENCE
  WEDDING
  CORPORATE
  GALA
  WORKSHOP
  BIRTHDAY
  PRIVATE_DINING
  OTHER
}

enum EventStatus {
  ENQUIRY
  QUOTED
  CONFIRMED
  ONGOING
  COMPLETED
  CANCELLED
}

// ─── Services (Spa, Housekeeping, Maintenance) ────────────────

model Service {
  id              String        @id @default(cuid())
  type            ServiceType
  status          ServiceStatus @default(REQUESTED)
  priority        ServicePriority @default(NORMAL)
  
  // Request Details
  description     String
  roomNumber      String?
  location        String?
  
  // Booking (if related)
  bookingId       String?
  booking         Booking?      @relation(fields: [bookingId], references: [id])
  
  // Assignment
  assignedTo      String?
  
  // Branch
  branchId        String
  branch          Branch        @relation(fields: [branchId], references: [id])
  
  // Timing
  requestedAt     DateTime      @default(now())
  scheduledFor    DateTime?
  startedAt       DateTime?
  completedAt     DateTime?
  
  // Metadata
  notes           String?
  rating          Int?
  feedback        String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([branchId])
  @@index([type])
  @@index([status])
}

enum ServiceType {
  HOUSEKEEPING
  MAINTENANCE
  SPA
  ROOM_SERVICE
  LAUNDRY
  CONCIERGE
  WAKE_UP_CALL
  OTHER
}

enum ServiceStatus {
  REQUESTED
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ServicePriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// ─── Staff Management ─────────────────────────────────────────

model Shift {
  id              String        @id @default(cuid())
  
  // Staff
  userId          String
  user            User          @relation(fields: [userId], references: [id])
  
  // Schedule
  date            DateTime
  startTime       String
  endTime         String
  type            ShiftType
  
  // Status
  status          ShiftStatus   @default(SCHEDULED)
  
  // Check in/out
  actualStart     DateTime?
  actualEnd       DateTime?
  
  // Metadata
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([userId])
  @@index([date])
  @@index([status])
}

enum ShiftType {
  MORNING
  AFTERNOON
  EVENING
  NIGHT
  SPLIT
}

enum ShiftStatus {
  SCHEDULED
  ACTIVE
  COMPLETED
  ABSENT
  CANCELLED
}

model PerformanceReview {
  id              String        @id @default(cuid())
  
  // Staff
  userId          String
  user            User          @relation(fields: [userId], references: [id])
  
  // Review
  period          String        // e.g., "Q1 2026"
  rating          Int           // 1-5
  strengths       String[]
  improvements    String[]
  comments        String?
  
  // Reviewers
  reviewedBy      String
  
  // Metadata
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([userId])
  @@index([period])
}

// ─── Maintenance & Housekeeping ───────────────────────────────

model MaintenanceLog {
  id              String        @id @default(cuid())
  
  // Room
  roomId          String
  room            Room          @relation(fields: [roomId], references: [id])
  
  // Issue
  issueType       String
  description     String
  severity        String        // Low, Medium, High, Critical
  
  // Resolution
  status          String        @default("Reported")
  resolvedAt      DateTime?
  resolution      String?
  
  // Staff
  reportedBy      String
  assignedTo      String?
  
  // Costs
  cost            Int?
  
  // Metadata
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([roomId])
  @@index([status])
}

model HousekeepingTask {
  id              String        @id @default(cuid())
  
  // Room
  roomId          String
  room            Room          @relation(fields: [roomId], references: [id])
  
  // Task
  type            String        // Deep Clean, Standard Clean, Turndown
  status          String        @default("Pending")
  priority        String        @default("Normal")
  
  // Assignment
  assignedTo      String?
  
  // Timing
  scheduledFor    DateTime
  startedAt       DateTime?
  completedAt     DateTime?
  
  // Quality Check
  inspected       Boolean       @default(false)
  inspectedBy     String?
  inspectionNotes String?
  
  // Metadata
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([roomId])
  @@index([status])
  @@index([scheduledFor])
}

// ─── Communication ────────────────────────────────────────────

model Message {
  id              String        @id @default(cuid())
  
  // Participants
  senderId        String
  sender          User          @relation("MessageSender", fields: [senderId], references: [id])
  receiverId      String
  receiver        User          @relation("MessageReceiver", fields: [receiverId], references: [id])
  
  // Content
  subject         String?
  body            String
  attachments     String[]
  
  // Status
  read            Boolean       @default(false)
  readAt          DateTime?
  
  // Metadata
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([senderId])
  @@index([receiverId])
  @@index([read])
}

model Notification {
  id              String        @id @default(cuid())
  
  // Recipient
  userId          String
  user            User          @relation(fields: [userId], references: [id])
  
  // Content
  type            NotificationType
  title           String
  message         String
  actionUrl       String?
  
  // Status
  read            Boolean       @default(false)
  readAt          DateTime?
  
  // Metadata
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([userId])
  @@index([read])
  @@index([type])
}

enum NotificationType {
  BOOKING
  PAYMENT
  ORDER
  SERVICE
  MAINTENANCE
  SHIFT
  REVIEW
  SYSTEM
}

// ─── Reviews & Feedback ───────────────────────────────────────

model Review {
  id              String        @id @default(cuid())
  
  // Guest
  guestId         String
  guest           Guest         @relation(fields: [guestId], references: [id])
  
  // Rating
  overallRating   Int           // 1-5
  cleanlinessRating Int?
  serviceRating   Int?
  valueRating     Int?
  locationRating  Int?
  
  // Content
  title           String?
  comment         String?
  
  // Response
  response        String?
  respondedAt     DateTime?
  respondedBy     String?
  
  // Status
  published       Boolean       @default(false)
  verified        Boolean       @default(false)
  
  // Metadata
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([guestId])
  @@index([overallRating])
  @@index([published])
}

// ─── Revenue & Analytics ──────────────────────────────────────

model Revenue {
  id              String        @id @default(cuid())
  
  // Branch
  branchId        String
  branch          Branch        @relation(fields: [branchId], references: [id])
  
  // Period
  date            DateTime
  month           String        // YYYY-MM
  year            Int
  
  // Revenue Streams
  roomRevenue     Int           @default(0)
  restaurantRevenue Int         @default(0)
  eventRevenue    Int           @default(0)
  spaRevenue      Int           @default(0)
  otherRevenue    Int           @default(0)
  totalRevenue    Int
  
  // Expenses
  totalExpenses   Int           @default(0)
  netRevenue      Int
  
  // Metrics
  occupancyRate   Float
  adr             Int           // Average Daily Rate
  revpar          Int           // Revenue Per Available Room
  
  // Guest Stats
  totalGuests     Int           @default(0)
  newGuests       Int           @default(0)
  returningGuests Int           @default(0)
  
  // Metadata
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@unique([branchId, date])
  @@index([branchId])
  @@index([month])
  @@index([year])
}
